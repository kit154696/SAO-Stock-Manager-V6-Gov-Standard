<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ñ‡∏∏‡∏°‡∏ß‡∏±‡∏™‡∏î‡∏∏ ‡∏≠‡∏õ‡∏ó. (‡∏ß.1095)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #2c3e50;
            --primary-light: #34495e;
            --accent: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #f4f6f9;
            --dark: #1a252f;
            --sidebar-width: 260px;
            --font-main: 'Sarabun', sans-serif;
        }

        * { box-sizing: border-box; outline: none; }
        body { margin: 0; font-family: var(--font-main); background-color: var(--light); color: #333; display: flex; height: 100vh; overflow: hidden; }

        /* Layout */
        .sidebar { width: var(--sidebar-width); background: var(--primary); color: white; display: flex; flex-direction: column; transition: 0.3s; z-index: 1000; }
        .sidebar .brand { padding: 20px; font-size: 1.2rem; font-weight: bold; background: rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px; }
        .sidebar .menu { flex: 1; padding: 10px 0; overflow-y: auto; }
        .menu-item { display: block; padding: 12px 20px; color: #b0c4de; text-decoration: none; transition: 0.2s; border-left: 4px solid transparent; }
        .menu-item:hover, .menu-item.active { background: var(--primary-light); color: white; border-left-color: var(--accent); }
        .menu-item i { margin-right: 10px; width: 20px; text-align: center; }
        .footer-menu { padding: 10px; border-top: 1px solid rgba(255,255,255,0.1); }

        .main-content { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        .header { background: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .header h2 { margin: 0; font-size: 1.2rem; }
        #btnMenu { display: none; background: none; border: none; font-size: 1.2rem; cursor: pointer; }

        /* Sections */
        .page-section { display: none; padding: 20px; overflow-y: auto; height: 100%; animation: fadeIn 0.3s; }
        .page-section.active { display: block; }

        /* Components */
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e0e0e0; }
        .card-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .card-header h3 { margin: 0; font-size: 1.1rem; color: var(--primary); }
        .card-body { padding: 20px; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { padding: 20px; display: flex; align-items: center; }
        .stat-card .icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-right: 15px; color: white; }
        .stat-card .info h3 { margin: 0 0 5px; font-size: 0.9rem; color: #777; font-weight: normal; }
        .stat-card .info p { margin: 0; font-size: 1.5rem; font-weight: bold; }
        .stat-card.blue .icon { background: var(--accent); }
        .stat-card.green .icon { background: var(--success); }
        .stat-card.red .icon { background: var(--danger); }
        .stat-card.orange .icon { background: var(--warning); }

        .content-grid { display: grid; grid-template-columns: 2fr 1.5fr; gap: 20px; }

        /* Tables */
        .table-responsive { overflow-x: auto; }
        .table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        .table th, .table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        .table th { background: #f8f9fa; font-weight: 600; color: #555; }
        .table-striped tbody tr:nth-of-type(odd) { background-color: rgba(0,0,0,0.02); }
        .table-hover tbody tr:hover { background-color: rgba(0,0,0,0.03); }
        .text-right { text-align: right; }
        .text-center { text-align: center; }

        /* Forms */
        .form-row { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; }
        .form-group { flex: 1; min-width: 200px; }
        .flex-2 { flex: 2; }
        .flex-3 { flex: 3; }
        .align-end { align-items: flex-end; }
        label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: var(--font-main); font-size: 1rem; }
        input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2); }

        /* Buttons */
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-family: var(--font-main); font-weight: 500; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn:hover { filter: brightness(0.9); transform: translateY(-1px); }

        /* Cart */
        .cart-box { background: #f0f4f8; padding: 20px; border-radius: 8px; border: 1px dashed #ccc; }
        .cart-box h4 { margin-top: 0; color: var(--primary); }

        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 500px; max-width: 90%; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: flex; flex-direction: column; max-height: 90vh; }
        .print-modal-content { width: 297mm; height: 90vh; max-width: 95%; } /* Landscape width */
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; text-align: right; gap: 10px; display: flex; justify-content: flex-end; }
        .close { font-size: 1.5rem; cursor: pointer; }

        /* Toast */
        .toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 12px 25px; border-radius: 5px; display: none; align-items: center; gap: 10px; z-index: 3000; animation: slideIn 0.3s; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Print Styles - A4 Landscape Official */
        .print-area { padding: 10mm; font-size: 14px; background: white; min-height: 100%; overflow: auto; }

        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -100%; height: 100%; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
            .sidebar.active { left: 0; }
            #btnMenu { display: block; }
            .content-grid { grid-template-columns: 1fr; }
            .form-row .flex-2, .form-row .flex-3 { flex: 1 100%; }
        }

        @media print {
            @page { size: A4 landscape; margin: 10mm; }
            body * { visibility: hidden; }
            #printModal, #printModal * { visibility: visible; }
            #printModal { position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: white; display: block !important; }
            .modal-content { box-shadow: none; border: none; width: 100%; height: auto; }
            .no-print { display: none !important; }
            .print-area { padding: 0; margin: 0; width: 100%; }
            
            /* Official Document Table Style */
            .print-table { width: 100%; border-collapse: collapse; font-size: 12pt; line-height: 1.4; }
            .print-table th, .print-table td { border: 1px solid black; padding: 6px; vertical-align: top; }
            .print-table th { text-align: center; background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; }
            .doc-header { text-align: center; margin-bottom: 20px; font-weight: bold; font-size: 16pt; }
            .doc-sub { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 12pt; }
            .sign-box { margin-top: 40px; display: flex; justify-content: space-between; flex-wrap: wrap; }
            .sign-item { width: 45%; text-align: center; margin-bottom: 30px; page-break-inside: avoid; }
        }
    </style>
</head>
<body>

    <nav class="sidebar" id="sidebar">
        <div class="brand">
            <i class="fas fa-boxes"></i>
            <span>e-Stock ‡∏≠‡∏õ‡∏ó.</span>
        </div>
        <div class="menu">
            <a href="#" class="menu-item active" onclick="nav('dashboard', this)">
                <i class="fas fa-chart-pie"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
            </a>
            <a href="#" class="menu-item" onclick="nav('transaction', this)">
                <i class="fas fa-exchange-alt"></i> ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ / ‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢
            </a>
            <a href="#" class="menu-item" onclick="nav('master', this)">
                <i class="fas fa-list-alt"></i> ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏™‡∏î‡∏∏
            </a>
            <a href="#" class="menu-item" onclick="nav('report', this)">
                <i class="fas fa-print"></i> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
            </a>
        </div>
        <div class="footer-menu">
            <a href="#" class="menu-item" onclick="backupData()">
                <i class="fas fa-download"></i> ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </a>
            <a href="#" class="menu-item" onclick="document.getElementById('fileRestore').click()">
                <i class="fas fa-upload"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </a>
            <input type="file" id="fileRestore" hidden onchange="restoreData(this)">
        </div>
    </nav>

    <main class="main-content">
        <header class="header">
            <button id="btnMenu" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            <h2 id="pageTitle">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</h2>
            <div class="user-info">
                <i class="fas fa-user-circle"></i> ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏™‡∏î‡∏∏
            </div>
        </header>

        <div id="toast" class="toast">
            <i class="fas fa-check-circle"></i> <span id="toastMsg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
        </div>

        <section id="dashboard" class="page-section active">
            <div class="stats-grid">
                <div class="card stat-card blue">
                    <div class="icon"><i class="fas fa-box"></i></div>
                    <div class="info">
                        <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                        <p id="d-totalItems">0</p>
                    </div>
                </div>
                <div class="card stat-card green">
                    <div class="icon"><i class="fas fa-coins"></i></div>
                    <div class="info">
                        <h3>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏Ñ‡∏•‡∏±‡∏á</h3>
                        <p id="d-totalValue">0.00</p>
                    </div>
                </div>
                <div class="card stat-card red">
                    <div class="icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="info">
                        <h3>‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î (Low)</h3>
                        <p id="d-lowStock">0</p>
                    </div>
                </div>
                <div class="card stat-card orange">
                    <div class="icon"><i class="fas fa-file-invoice"></i></div>
                    <div class="info">
                        <h3>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</h3>
                        <p id="d-totalDocs">0</p>
                    </div>
                </div>
            </div>

            <div class="content-grid">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-bar"></i> ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏Ñ‡∏•‡∏±‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="catChart" height="250"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-bell"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠ (Low Stock)</h3>
                    </div>
                    <div class="card-body table-responsive">
                        <table class="table table-striped" id="lowStockTable">
                            <thead>
                                <tr>
                                    <th>‡∏ß‡∏±‡∏™‡∏î‡∏∏</th>
                                    <th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                                    <th>Min</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="transaction" class="page-section">
            <div class="card">
                <div class="card-header">
                    <h3>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ / ‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢</h3>
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label>
                            <select id="txType" onchange="toggleTxType()">
                                <option value="OUT">üî¥ ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏ (OUT)</option>
                                <option value="IN">üü¢ ‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö/‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤ (IN)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label>
                            <input type="date" id="txDate" onchange="genDocNo()">
                        </div>
                        <div class="form-group">
                            <label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label>
                            <input type="text" id="txDocNo" readonly style="background-color: #eee;">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group flex-2">
                            <label id="lblRef">‡πÄ‡∏ö‡∏¥‡∏Å‡πÇ‡∏î‡∏¢ (‡∏Å‡∏≠‡∏á/‡∏ù‡πà‡∏≤‡∏¢)</label>
                            <div class="input-group">
                                <input type="text" id="txRef" list="dlDepts" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô/‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤">
                                <datalist id="dlDepts"></datalist>
                            </div>
                        </div>
                        <div class="form-group flex-2">
                            <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                            <input type="text" id="txNote">
                        </div>
                    </div>

                    <div class="cart-box">
                        <h4><i class="fas fa-cart-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏™‡∏î‡∏∏</h4>
                        <div class="form-row align-end">
                            <div class="form-group flex-3">
                                <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡∏±‡∏™‡∏î‡∏∏ (‡∏£‡∏´‡∏±‡∏™ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠)</label>
                                <input type="text" id="cartItemInput" list="dlItems" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." onchange="selectCartItem()">
                                <datalist id="dlItems"></datalist>
                                <input type="hidden" id="cartItemId">
                            </div>
                            <div class="form-group">
                                <label>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</label>
                                <input type="text" id="cartBal" readonly style="text-align: center; background: #f9f9f9;">
                            </div>
                            <div class="form-group" id="grpPrice" style="display:none;">
                                <label>‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
                                <input type="number" id="cartPrice" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                                <input type="number" id="cartQty" min="1" value="1">
                            </div>
                            <div class="form-group">
                                <button class="btn btn-primary" onclick="addToCart()">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                            </div>
                        </div>

                        <div class="table-responsive mt-2">
                            <table class="table" id="cartTable">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>‡∏£‡∏´‡∏±‡∏™</th>
                                        <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                        <th class="text-right">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                                        <th class="text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                        <th class="text-right">‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô</th>
                                        <th class="text-center">‡∏•‡∏ö</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="form-row mt-3" style="background:#f8f9fa; padding:15px; border-radius:5px;">
                        <div class="form-group">
                            <label>‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥/‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å</label>
                            <input type="text" id="txUser" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•">
                        </div>
                        <div class="form-group">
                            <label>‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á‡∏à‡πà‡∏≤‡∏¢/‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</label>
                            <input type="text" id="txApprover" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• (‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)">
                        </div>
                        <div class="form-group">
                            <label>‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</label>
                            <input type="text" id="txChecker" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• (‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)">
                        </div>
                    </div>

                    <div class="form-actions mt-3 text-right">
                        <button class="btn btn-success btn-lg" onclick="saveTransaction()"><i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</button>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header"><h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3></div>
                <div class="card-body table-responsive">
                    <table class="table table-striped" id="txHistoryTable">
                        <thead>
                            <tr>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                                <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                                <th>‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á</th>
                                <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="master" class="page-section">
            <div class="card">
                <div class="card-header flex-between">
                    <h3>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏°‡∏ß‡∏±‡∏™‡∏î‡∏∏</h3>
                    <button class="btn btn-primary" onclick="openMasterModal()"><i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏™‡∏î‡∏∏</button>
                </div>
                <div class="card-body">
                    <div class="filter-bar">
                        <input type="text" id="searchMaster" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏™‡∏î‡∏∏..." onkeyup="renderMaster()">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover" id="masterTable">
                            <thead>
                                <tr>
                                    <th>‡∏£‡∏´‡∏±‡∏™</th>
                                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏™‡∏î‡∏∏ (‡∏™‡πÄ‡∏õ‡∏Ñ)</th>
                                    <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                                    <th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                                    <th class="text-center">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                                    <th class="text-right">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                                    <th class="text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="report" class="page-section">
            <div class="card">
                <div class="card-header">
                    <h3>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h3>
                </div>
                <div class="card-body">
                    <div class="form-row align-end">
                        <div class="form-group flex-2">
                            <label>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (‡∏´‡∏±‡∏ß‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô)</label>
                            <input type="text" id="orgNameInput" value="‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≥‡∏ö‡∏•..." onchange="updateOrgName()">
                        </div>
                        <div class="form-group">
                            <label>‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                            <input type="date" id="repDate">
                        </div>
                        <div class="form-group flex-2">
                            <label>‡∏´‡∏°‡∏ß‡∏î‡∏ß‡∏±‡∏™‡∏î‡∏∏</label>
                            <select id="repCatFilter">
                                <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="genReport()"><i class="fas fa-search"></i> ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                        </div>
                    </div>
                    
                    <div id="reportResult" class="report-container mt-3">
                        <div class="text-center text-muted py-5">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <div id="masterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏™‡∏î‡∏∏</h3>
                <span class="close" onclick="closeModal('masterModal')">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="mId">
                <div class="form-row">
                    <div class="form-group">
                        <label>‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏∏</label>
                        <input type="text" id="mCode" required>
                    </div>
                    <div class="form-group flex-2">
                        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏™‡∏î‡∏∏</label>
                        <input type="text" id="mName" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>‡∏Ñ‡∏∏‡∏ì‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞/‡∏™‡πÄ‡∏õ‡∏Ñ</label>
                    <input type="text" id="mSpec">
                </div>
                <div class="form-row">
                    <div class="form-group flex-2">
                        <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡∏ß.1095)</label>
                        <select id="mCat"></select>
                    </div>
                    <div class="form-group">
                        <label>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</label>
                        <input type="text" id="mUnit" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>‡∏à‡∏∏‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Min)</label>
                        <input type="number" id="mMin" value="0">
                    </div>
                    <div class="form-group">
                        <label>‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö</label>
                        <input type="text" id="mLoc">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('masterModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="btn btn-success" onclick="saveMaster()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <div id="printModal" class="modal">
        <div class="modal-content print-modal-content">
            <div class="modal-header no-print">
                <h3>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå</h3>
                <div>
                    <button class="btn btn-primary" onclick="window.print()"><i class="fas fa-print"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå (A4 ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô)</button>
                    <button class="btn btn-danger" onclick="closeModal('printModal')">‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
            <div id="printArea" class="print-area">
                </div>
        </div>
    </div>

    <script>
        // --- Constants & Config ---
        const DB_KEY = 'LAO_STOCK_DB_V1';
        const CATEGORIES = {
            'A0000': '‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', 'B0000': '‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ó‡∏¢‡∏∏', 'C0000': '‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏á‡∏≤‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡∏ß',
            'D0000': '‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á', 'E0000': '‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏Ç‡∏ô‡∏™‡πà‡∏á', 'F0000': '‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏¥‡∏á‡πÅ‡∏•‡∏∞‡∏´‡∏•‡πà‡∏≠‡∏•‡∏∑‡πà‡∏ô',
            'G0000': '‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå', 'H0000': '‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£', 'I0000': '‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà',
            'J0000': '‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢', 'K0000': '‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏Å‡∏µ‡∏¨‡∏≤', 'L0000': '‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå',
            'M0000': '‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤', 'N0000': '‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏î‡∏ô‡∏ï‡∏£‡∏µ‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏è‡∏®‡∏¥‡∏•‡∏õ‡πå', 'O0000': '‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£',
            'P0000': '‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏™‡∏≥‡∏£‡∏ß‡∏à', 'Q0000': '‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏≠‡∏∑‡πà‡∏ô'
        };
        const DEPARTMENTS = [
            '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏õ‡∏•‡∏±‡∏î', '‡∏Å‡∏≠‡∏á‡∏Ñ‡∏•‡∏±‡∏á', '‡∏Å‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á', '‡∏Å‡∏≠‡∏á‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°', 
            '‡∏Å‡∏≠‡∏á‡∏¢‡∏∏‡∏ó‡∏ò‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì', '‡∏Å‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤', '‡∏Å‡∏≠‡∏á‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏á‡∏Ñ‡∏°', 
            '‡∏Å‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà', '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô'
        ];

        let DB = { orgName: '‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≥‡∏ö‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á', items: [], tx: [] };
        let cart = [];
        let chartInstance = null;

        // --- Init & Data Management ---
        window.onload = () => {
            loadDB();
            initUI();
            renderDashboard();
        };

        function loadDB() {
            const data = localStorage.getItem(DB_KEY);
            if (data) {
                DB = JSON.parse(data);
            } else {
                seedDataIfEmpty();
            }
        }

        function saveDB() {
            localStorage.setItem(DB_KEY, JSON.stringify(DB));
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }

        function seedDataIfEmpty() {
            if (DB.items.length > 0) return;
            
            // Seed 200+ items
            const catKeys = Object.keys(CATEGORIES);
            for (let i = 1; i <= 200; i++) {
                const catKey = catKeys[Math.floor(Math.random() * catKeys.length)];
                const id = Date.now() + i;
                DB.items.push({
                    id: id,
                    code: `${catKey.charAt(0)}${String(i).padStart(4, '0')}`,
                    name: `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏î‡∏™‡∏≠‡∏ö ${i}`,
                    spec: `‡∏Ç‡∏ô‡∏≤‡∏î ${Math.floor(Math.random()*100)} unit`,
                    catCode: catKey,
                    catName: CATEGORIES[catKey],
                    unit: ['‡∏ä‡∏¥‡πâ‡∏ô', '‡∏≠‡∏±‡∏ô', '‡∏Å‡∏•‡πà‡∏≠‡∏á', '‡∏ä‡∏∏‡∏î', '‡πÄ‡∏•‡πà‡∏°', '‡∏°‡πâ‡∏ß‡∏ô'][Math.floor(Math.random()*6)],
                    min: Math.floor(Math.random() * 10) + 5,
                    loc: `‡∏ï‡∏π‡πâ ${Math.floor(Math.random()*10)+1}`,
                    lastPrice: Math.floor(Math.random() * 500) + 10
                });
                
                // Initial Stock (Transaction)
                DB.tx.push({
                    id: Date.now() + i + 1000,
                    date: '2025-10-01',
                    type: 'IN',
                    docNo: '‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤',
                    ref: '-',
                    note: '‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö',
                    lines: [{ itemId: id, qty: Math.floor(Math.random() * 50) + 20, price: 0 }]
                });
            }
            saveDB();
        }

        function initUI() {
            // Populate Dropdowns
            const catSelect = document.getElementById('mCat');
            const filterSelect = document.getElementById('repCatFilter');
            Object.entries(CATEGORIES).forEach(([code, name]) => {
                const opt = `<option value="${code}">${code} ${name}</option>`;
                catSelect.innerHTML += opt;
                filterSelect.innerHTML += opt;
            });

            const deptDL = document.getElementById('dlDepts');
            DEPARTMENTS.forEach(d => deptDL.innerHTML += `<option value="${d}">`);

            // Date Defaults
            document.getElementById('txDate').valueAsDate = new Date();
            document.getElementById('repDate').valueAsDate = new Date();
            document.getElementById('orgNameInput').value = DB.orgName;

            // Event Listeners
            document.getElementById('mCat').addEventListener('change', (e) => {
                const txt = e.target.options[e.target.selectedIndex].text;
            });
        }

        // --- Logic Helpers ---
        function getFiscalYear(dateStr) {
            const d = new Date(dateStr);
            // ‡∏õ‡∏µ‡∏á‡∏ö‡πÑ‡∏ó‡∏¢ = ‡∏õ‡∏µ ‡∏û.‡∏®. ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏ï.‡∏Ñ. ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ (‡∏õ‡∏µ‡∏Ñ.‡∏®. + 543)
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô >= 10 (‡∏ï‡∏∏‡∏•‡∏≤) ‡∏Ñ‡∏∑‡∏≠‡∏õ‡∏µ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
            const year = d.getFullYear();
            const month = d.getMonth() + 1;
            const fy = (month >= 10) ? year + 1 : year;
            return fy + 543;
        }

        function getThaiDate(dateStr) {
            if(!dateStr) return '';
            const d = new Date(dateStr);
            const months = ['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];
            return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()+543}`;
        }

        function getBal(itemId, dateLimit = null) {
            let bal = 0;
            DB.tx.forEach(t => {
                if (dateLimit && t.date > dateLimit) return;
                t.lines.forEach(l => {
                    if (l.itemId == itemId) {
                        if (t.type === 'IN') bal += parseFloat(l.qty);
                        else bal -= parseFloat(l.qty);
                    }
                });
            });
            return bal;
        }

        function genDocNo() {
            const date = document.getElementById('txDate').value;
            const type = document.getElementById('txType').value;
            const fy = getFiscalYear(date);
            const fyShort = String(fy).slice(-2);
            
            // Count docs of this type in this FY
            const count = DB.tx.filter(t => t.type === type && getFiscalYear(t.date) === fy).length + 1;
            const run = String(count).padStart(4, '0');
            document.getElementById('txDocNo').value = `${type}-${run}/${fyShort}`;
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.style.display = 'flex';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        // --- Navigation & UI ---
        function nav(pageId, el) {
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            if(el) el.classList.add('active');

            document.getElementById('pageTitle').innerText = el ? el.innerText.trim() : 'System';

            // Mobile sidebar close
            if(window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('active');

            if (pageId === 'dashboard') renderDashboard();
            if (pageId === 'transaction') { 
                resetTxForm(); renderTxHistory(); 
            }
            if (pageId === 'master') renderMaster();
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // --- Dashboard ---
        function renderDashboard() {
            const ctx = document.getElementById('catChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            let totalItems = DB.items.length;
            let totalValue = 0;
            let lowStockCount = 0;
            let lowStockHtml = '';
            const currentFY = getFiscalYear(new Date());
            let docsThisYear = DB.tx.filter(t => getFiscalYear(t.date) === currentFY).length;
            let catValue = {};

            DB.items.forEach(item => {
                const bal = getBal(item.id);
                const val = bal * item.lastPrice;
                totalValue += val;
                
                if (bal <= item.min) {
                    lowStockCount++;
                    lowStockHtml += `<tr><td>${item.code} ${item.name}</td><td class="text-center text-danger font-weight-bold">${bal}</td><td class="text-center">${item.min}</td></tr>`;
                }

                catValue[item.catName] = (catValue[item.catName] || 0) + val;
            });

            document.getElementById('d-totalItems').innerText = totalItems;
            document.getElementById('d-totalValue').innerText = totalValue.toLocaleString(undefined, {minimumFractionDigits:2});
            document.getElementById('d-lowStock').innerText = lowStockCount;
            document.getElementById('d-totalDocs').innerText = docsThisYear;
            document.getElementById('lowStockTable').querySelector('tbody').innerHTML = lowStockHtml || '<tr><td colspan="3" class="text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</td></tr>';

            // Chart
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(catValue),
                    datasets: [{
                        label: '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏Ñ‡∏•‡∏±‡∏á (‡∏ö‡∏≤‡∏ó)',
                        data: Object.values(catValue),
                        backgroundColor: '#3498db'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // --- Master Data ---
        function renderMaster() {
            const tbody = document.querySelector('#masterTable tbody');
            const keyword = document.getElementById('searchMaster').value.toLowerCase();
            tbody.innerHTML = '';

            const filtered = DB.items.filter(i => 
                i.code.toLowerCase().includes(keyword) || 
                i.name.toLowerCase().includes(keyword)
            );

            filtered.forEach(i => {
                const bal = getBal(i.id);
                tbody.innerHTML += `
                    <tr>
                        <td>${i.code}</td>
                        <td>${i.name} <br><small class="text-muted">${i.spec}</small></td>
                        <td>${i.catName}</td>
                        <td>${i.unit}</td>
                        <td class="text-center ${bal <= i.min ? 'text-danger font-weight-bold' : ''}">${bal}</td>
                        <td class="text-right">${i.lastPrice.toFixed(2)}</td>
                        <td class="text-center">
                            <button class="btn btn-secondary btn-sm" onclick="editMaster(${i.id})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-primary btn-sm" onclick="printStockCard(${i.id})"><i class="fas fa-print"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        function openMasterModal() {
            document.getElementById('mId').value = '';
            document.getElementById('mCode').value = '';
            document.getElementById('mName').value = '';
            document.getElementById('mSpec').value = '';
            document.getElementById('mCat').value = 'A0000';
            document.getElementById('mUnit').value = '';
            document.getElementById('mMin').value = 0;
            document.getElementById('mLoc').value = '';
            document.getElementById('masterModal').style.display = 'flex';
        }

        function editMaster(id) {
            const item = DB.items.find(i => i.id === id);
            if (!item) return;
            document.getElementById('mId').value = item.id;
            document.getElementById('mCode').value = item.code;
            document.getElementById('mName').value = item.name;
            document.getElementById('mSpec').value = item.spec;
            document.getElementById('mCat').value = item.catCode;
            document.getElementById('mUnit').value = item.unit;
            document.getElementById('mMin').value = item.min;
            document.getElementById('mLoc').value = item.loc;
            document.getElementById('masterModal').style.display = 'flex';
        }

        function saveMaster() {
            const id = document.getElementById('mId').value;
            const catCode = document.getElementById('mCat').value;
            const catName = CATEGORIES[catCode];
            
            const newItem = {
                id: id ? parseInt(id) : Date.now(),
                code: document.getElementById('mCode').value,
                name: document.getElementById('mName').value,
                spec: document.getElementById('mSpec').value,
                catCode: catCode,
                catName: catName,
                unit: document.getElementById('mUnit').value,
                min: parseInt(document.getElementById('mMin').value) || 0,
                loc: document.getElementById('mLoc').value,
                lastPrice: id ? DB.items.find(i => i.id == id).lastPrice : 0
            };

            if (id) {
                const index = DB.items.findIndex(i => i.id == id);
                DB.items[index] = newItem;
            } else {
                DB.items.push(newItem);
            }
            
            saveDB();
            closeModal('masterModal');
            renderMaster();
        }

        // --- Transaction & Cart ---
        function toggleTxType() {
            const type = document.getElementById('txType').value;
            document.getElementById('grpPrice').style.display = (type === 'IN') ? 'block' : 'none';
            document.getElementById('lblRef').innerText = (type === 'IN') ? '‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å (‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó)' : '‡πÄ‡∏ö‡∏¥‡∏Å‡πÇ‡∏î‡∏¢ (‡∏Å‡∏≠‡∏á/‡∏ù‡πà‡∏≤‡∏¢)';
            genDocNo();
            updateDataList();
        }

        function updateDataList() {
            const dl = document.getElementById('dlItems');
            dl.innerHTML = '';
            DB.items.forEach(i => {
                dl.innerHTML += `<option value="${i.code} : ${i.name}">[${i.spec}] ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${getBal(i.id)} ${i.unit}</option>`;
            });
        }

        function selectCartItem() {
            const val = document.getElementById('cartItemInput').value;
            const code = val.split(':')[0].trim();
            const item = DB.items.find(i => i.code === code);
            if (item) {
                document.getElementById('cartItemId').value = item.id;
                document.getElementById('cartBal').value = getBal(item.id);
                document.getElementById('cartPrice').value = item.lastPrice;
            }
        }

        function addToCart() {
            const itemId = document.getElementById('cartItemId').value;
            if (!itemId) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏');
            
            const item = DB.items.find(i => i.id == itemId);
            const qty = parseFloat(document.getElementById('cartQty').value);
            const price = parseFloat(document.getElementById('cartPrice').value) || 0;
            const type = document.getElementById('txType').value;
            const currentBal = getBal(item.id);

            if (qty <= 0) return alert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0');

            // Validation for OUT
            if (type === 'OUT') {
                const inCartQty = cart.filter(c => c.itemId == itemId).reduce((sum, c) => sum + c.qty, 0);
                if (qty + inCartQty > currentBal) return alert(`‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠! (‡∏°‡∏µ ${currentBal})`);
            }

            cart.push({ 
                itemId: item.id, code: item.code, name: item.name, spec: item.spec, 
                unit: item.unit, qty: qty, price: price 
            });
            
            renderCart();
            document.getElementById('cartItemInput').value = '';
            document.getElementById('cartItemId').value = '';
            document.getElementById('cartQty').value = 1;
        }

        function renderCart() {
            const tb = document.querySelector('#cartTable tbody');
            tb.innerHTML = '';
            cart.forEach((c, idx) => {
                tb.innerHTML += `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${c.code}</td>
                        <td>${c.name} <small>${c.spec}</small></td>
                        <td class="text-right">${c.price.toFixed(2)}</td>
                        <td class="text-center">${c.qty} ${c.unit}</td>
                        <td class="text-right">${(c.qty * c.price).toFixed(2)}</td>
                        <td class="text-center"><button class="btn btn-danger btn-sm" onclick="cart.splice(${idx},1);renderCart()"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `;
            });
        }

        function saveTransaction() {
            if (cart.length === 0) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£');
            
            const type = document.getElementById('txType').value;
            const tx = {
                id: Date.now(),
                date: document.getElementById('txDate').value,
                type: type,
                docNo: document.getElementById('txDocNo').value,
                ref: document.getElementById('txRef').value,
                note: document.getElementById('txNote').value,
                user: document.getElementById('txUser').value,
                approver: document.getElementById('txApprover').value,
                checker: document.getElementById('txChecker').value,
                lines: [...cart]
            };

            // Update Last Price for IN
            if (type === 'IN') {
                tx.lines.forEach(l => {
                    const item = DB.items.find(i => i.id == l.itemId);
                    if(item) item.lastPrice = l.price;
                });
            }

            DB.tx.push(tx);
            saveDB();
            
            if (type === 'OUT' && confirm('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                printWithdrawSlip(tx.id);
            } else {
                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            }

            resetTxForm();
            renderTxHistory();
        }

        function resetTxForm() {
            cart = [];
            renderCart();
            genDocNo();
            updateDataList();
            document.getElementById('txRef').value = '';
            document.getElementById('txNote').value = '';
            document.getElementById('cartItemInput').value = '';
        }

        function renderTxHistory() {
            const tb = document.querySelector('#txHistoryTable tbody');
            tb.innerHTML = '';
            // Last 10
            DB.tx.slice().sort((a,b) => b.id - a.id).slice(0, 10).forEach(t => {
                tb.innerHTML += `
                    <tr>
                        <td>${getThaiDate(t.date)}</td>
                        <td>${t.docNo}</td>
                        <td><span style="color:${t.type=='IN'?'green':'red'}">${t.type}</span></td>
                        <td>${t.ref}</td>
                        <td>${t.lines.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="printWithdrawSlip(${t.id})" ${t.type=='IN'?'disabled':''}><i class="fas fa-print"></i></button>
                            <button class="btn btn-danger btn-sm" onclick="deleteTx(${t.id})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        function deleteTx(id) {
            if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà')) {
                DB.tx = DB.tx.filter(t => t.id !== id);
                saveDB();
                renderTxHistory();
            }
        }

        // --- Reporting & Printing ---
        function updateOrgName() {
            DB.orgName = document.getElementById('orgNameInput').value;
            saveDB();
        }

        function genReport() {
            const dateLimit = document.getElementById('repDate').value;
            const catFilter = document.getElementById('repCatFilter').value;
            const orgName = document.getElementById('orgNameInput').value;

            let items = DB.items;
            if (catFilter) items = items.filter(i => i.catCode === catFilter);
            items.sort((a,b) => a.catCode.localeCompare(b.catCode));

            let html = `
                <div class="doc-header">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠<br><span style="font-size:14pt">${orgName}</span></div>
                <div class="doc-sub">
                    <span>‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${getThaiDate(dateLimit)}</span>
                    <span>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${catFilter ? CATEGORIES[catFilter] : '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'}</span>
                </div>
                <table class="print-table">
                    <thead>
                        <tr>
                            <th width="5%">‡∏ó‡∏µ‡πà</th>
                            <th width="15%">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                            <th width="35%">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / ‡∏Ñ‡∏∏‡∏ì‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞</th>
                            <th width="10%">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                            <th width="10%">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                            <th width="10%">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                            <th width="15%">‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            let seq = 1;
            let grandTotal = 0;

            items.forEach(item => {
                const bal = getBal(item.id, dateLimit);
                if (bal > 0) { // Only show items with stock
                    const total = bal * item.lastPrice;
                    grandTotal += total;
                    html += `
                        <tr>
                            <td class="text-center">${seq++}</td>
                            <td>${item.catName}</td>
                            <td>${item.name} <br> ${item.spec}</td>
                            <td class="text-center">${item.unit}</td>
                            <td class="text-right">${item.lastPrice.toFixed(2)}</td>
                            <td class="text-center">${bal}</td>
                            <td class="text-right">${total.toFixed(2)}</td>
                        </tr>
                    `;
                }
            });

            html += `
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="6" class="text-right font-weight-bold">‡∏£‡∏ß‡∏°‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</td>
                            <td class="text-right font-weight-bold" style="background:#eee">${grandTotal.toFixed(2)}</td>
                        </tr>
                    </tfoot>
                </table>
                
                <div class="sign-box">
                    <div class="sign-item"></div>
                    <div class="sign-item">
                        <br><br>
                        (‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠).................................................‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö<br>
                        (.................................................)<br>
                        ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á.................................................<br>
                        ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà......../......../............
                    </div>
                </div>
            `;

            openPrint(html);
        }

        function printWithdrawSlip(txId) {
            const tx = DB.tx.find(t => t.id === txId);
            if (!tx) return;

            let rows = '';
            tx.lines.forEach((l, idx) => {
                rows += `
                    <tr>
                        <td class="text-center">${idx+1}</td>
                        <td>${l.name} (${l.spec})</td>
                        <td class="text-center">${l.qty}</td>
                        <td class="text-center">${l.unit}</td>
                        <td></td>
                    </tr>
                `;
            });

            const html = `
                <div class="doc-header">‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏<br><span style="font-size:12pt; font-weight:normal">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${tx.docNo}</span></div>
                <div class="doc-sub text-right">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${getThaiDate(tx.date)}</div>
                <p><b>‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</b> ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏û‡∏±‡∏™‡∏î‡∏∏</p>
                <p style="text-indent: 40px">‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤ <b>${tx.ref}</b> ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ ‡∏î‡∏±‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ</p>
                
                <table class="print-table">
                    <thead>
                        <tr>
                            <th width="10%">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                            <th width="50%">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                            <th width="15%">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å</th>
                            <th width="10%">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                            <th width="15%">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>

                <div class="sign-box">
                    <div class="sign-item">
                        <br>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠........................................‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å<br>
                        (${tx.user || '........................................'})<br>
                        ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á........................................<br>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà......../......../............
                    </div>
                    <div class="sign-item">
                        <br>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠........................................‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥<br>
                        (${tx.approver || '........................................'})<br>
                        ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á........................................<br>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà......../......../............
                    </div>
                    <div class="sign-item">
                        <br>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠........................................‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢<br>
                        (........................................)<br>
                        ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á........................................<br>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà......../......../............
                    </div>
                    <div class="sign-item">
                        <br>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠........................................‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö<br>
                        (${tx.checker || '........................................'})<br>
                        ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á........................................<br>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà......../......../............
                    </div>
                </div>
            `;
            openPrint(html);
        }

        function printStockCard(itemId) {
            const item = DB.items.find(i => i.id === itemId);
            const txs = DB.tx.filter(t => t.lines.some(l => l.itemId === itemId));
            txs.sort((a,b) => new Date(a.date) - new Date(b.date));

            let rows = '';
            let bal = 0;
            
            txs.forEach(t => {
                const line = t.lines.find(l => l.itemId === itemId);
                let inQty = '', outQty = '';
                if (t.type === 'IN') { inQty = line.qty; bal += line.qty; }
                else { outQty = line.qty; bal -= line.qty; }

                rows += `
                    <tr>
                        <td class="text-center" style="font-size:10pt">${getThaiDate(t.date)}</td>
                        <td style="font-size:10pt">${t.type=='IN' ? '‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å '+t.ref : '‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ '+t.ref}</td>
                        <td class="text-center">${t.docNo}</td>
                        <td class="text-right">${t.type=='IN' ? line.price.toFixed(2) : ''}</td>
                        <td class="text-center">${inQty}</td>
                        <td class="text-center">${outQty}</td>
                        <td class="text-center"><b>${bal}</b></td>
                        <td>${t.note || ''}</td>
                    </tr>
                `;
            });

            const html = `
                <div class="doc-header">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ß‡∏±‡∏™‡∏î‡∏∏<br><span style="font-size:14pt">${DB.orgName}</span></div>
                <div style="border: 1px solid black; padding: 10px; margin-bottom: 10px; font-size: 12pt;">
                    <div style="display:flex; justify-content:space-between">
                        <div><b>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</b> ${item.catName}</div>
                        <div><b>‡∏£‡∏´‡∏±‡∏™:</b> ${item.code}</div>
                    </div>
                    <div style="display:flex; justify-content:space-between">
                        <div><b>‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏™‡∏î‡∏∏:</b> ${item.name}</div>
                        <div><b>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö:</b> ${item.unit}</div>
                    </div>
                    <div style="display:flex; justify-content:space-between">
                        <div><b>‡∏Ç‡∏ô‡∏≤‡∏î/‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞:</b> ${item.spec}</div>
                        <div><b>‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö:</b> ${item.loc} &nbsp; <b>Min:</b> ${item.min}</div>
                    </div>
                </div>
                
                <table class="print-table">
                    <thead>
                        <tr>
                            <th rowspan="2" width="12%">‡∏ß/‡∏î/‡∏õ</th>
                            <th rowspan="2" width="23%">‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å / ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ</th>
                            <th rowspan="2" width="10%">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                            <th rowspan="2" width="10%">‡∏£‡∏≤‡∏Ñ‡∏≤<br>‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                            <th colspan="3">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                            <th rowspan="2" width="15%">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                        </tr>
                        <tr>
                            <th width="10%">‡∏£‡∏±‡∏ö</th>
                            <th width="10%">‡∏à‡πà‡∏≤‡∏¢</th>
                            <th width="10%">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
            `;
            openPrint(html);
        }

        function openPrint(content) {
            document.getElementById('printArea').innerHTML = content;
            document.getElementById('printModal').style.display = 'flex';
        }

        // --- Backup / Restore ---
        function backupData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(DB));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "lao_stock_backup_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showToast('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        }

        function restoreData(input) {
            const file = input.files[0];
            if (!file) return;
            
            if (confirm('‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ó‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.items && data.tx) {
                            DB = data;
                            saveDB();
                            location.reload();
                        } else {
                            alert('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                        }
                    } catch (err) {
                        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå');
                    }
                };
                reader.readAsText(file);
            }
        }
    </script>
</body>
</html>
